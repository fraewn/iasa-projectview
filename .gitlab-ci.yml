variables:
  CACHE_DIR: cache
  MAVEN_CACHE_DIR: $CACHE_DIR/.m2
  GIT_CLEAN_FLAGS: -ffdx -e node_modules/ -e "$MAVEN_CACHE_DIR/"
  MAVEN_OPTS: -Dmaven.repo.local=$CI_PROJECT_DIR/$MAVEN_CACHE_DIR/repository

stages:
  - dependencies
  - compile
  - test
  - build

npm:
  image: node:latest
  stage: dependencies
  script: npm install
  cache:
    key: npm
    paths:
      - node_modules/
    policy: push

maven:
  image: maven:3.6.3-jdk-8
  stage: dependencies
  script:
    - mvn dependency:resolve
    - ls -la
  cache:
    key: maven
    paths:
      - $MAVEN_CACHE_DIR/repository/
    policy: push

compile-angular:
  image: node:latest
  stage: compile
  script:
    - ls -la
    - node_modules/.bin/ng build --prod
  artifacts:
    expire_in: 12 hours
    paths:
      - src/server/resources/static/
  cache:
    key: npm
    policy: pull
  dependencies:
    - npm

compile-kotlin:
  image: maven:3.6.3-jdk-8
  stage: compile
  script:
    - chmod a+x ./mvnw
    - ./mvnw compile
  artifacts:
    expire_in: 12 hours
    paths:
      - target/classes
      - target/generated-sources
      - target/maven-status
  cache:
    key: maven
    policy: pull

test-angular:
  image: node:latest
  stage: test
  script:
    - ls

#test-kotlin:
#  image: maven:3.6.3-jdk-8
#  stage: test
#  script:
#    - ./mvnw test

package:
  image: maven:3.6.3-jdk-8
  stage: build
  script:
    - chmod a+x ./mvnw
    - ./mvnw install -Dmaven.test.skip=true
    - ls -la
  dependencies:
    - compile-kotlin
    - compile-angular
  artifacts:
    expire_in: 12 hours
    paths:
      - target/projectview-0.0.1.jar
  cache:
    key: maven
    policy: pull

